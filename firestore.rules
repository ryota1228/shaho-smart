rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // -----------------------------
    // companies/{companyId}/employees/{employeeId}
    // 従業員データへのアクセス制御
    // -----------------------------
    match /companies/{companyId}/employees/{employeeId} {
      allow read: if isHr(companyId) || isSelf(companyId, employeeId);
      allow write: if isHr(companyId);
    }

    // -----------------------------
    // users/{uid}
    // -----------------------------
    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // -----------------------------
    // users/{uid}/userCompanies/{companyId}
    // 所属企業ごとの employeeId・role 情報
    // -----------------------------
    match /users/{uid}/userCompanies/{companyId} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // -----------------------------
    // ユーティリティ関数（共通認証・ロール確認）
    // -----------------------------
    function getUserCompanyData(companyId) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)/userCompanies/$(companyId)).data;
    }

    function isHr(companyId) {
      return request.auth != null &&
             getUserCompanyData(companyId).role == "hr";
    }

    function isSelf(companyId, employeeId) {
      return request.auth != null &&
             getUserCompanyData(companyId).employeeId == employeeId;
    }
  }
}

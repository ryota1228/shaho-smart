<div class="insurance-premium-wrapper">

  <mat-card class="company-list">
    <mat-card-title>企業一覧</mat-card-title>
    <mat-card-content>
      <table mat-table [dataSource]="companyList" class="mat-elevation-z1" style="width: 100%;">
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>企業名</th>
          <td mat-cell *matCellDef="let company">
            <button mat-button (click)="selectCompany(company)">
              {{ company.name }}
            </button>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="['name']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['name']"></tr>
      </table>
    </mat-card-content>
  </mat-card>

  <mat-card *ngIf="selectedCompanyId">
    <mat-card-title>対象月を選択</mat-card-title>
    <mat-card-content>
  
      <div class="selection-row">
        <mat-form-field appearance="outline">
          <mat-label>対象月</mat-label>
          <input matInput type="month" [(ngModel)]="selectedMonth" (ngModelChange)="onMonthChange()">
        </mat-form-field>
  
        <mat-slide-toggle
        *ngIf="userRole === 'hr'"
        [(ngModel)]="devForceAllButtons"
        color="warn"
        (change)="onDevModeToggleChanged()"
      >
        開発モード：すべての操作ボタンを強制有効化
      </mat-slide-toggle>
      </div>
  

      <div class="button-row" *ngIf="userRole === 'hr'">

      
        <button
        mat-raised-button
        color="primary"
        (click)="registerQualificationForAll()"
        [disabled]="!canRegisterQualificationForAnyEmployee()"
      >
        資格取得（当月/一括）
      </button>
      
      <button
      mat-raised-button
      color="accent"
      (click)="registerFixedForAll()"
      [disabled]="!selectedMonth || !canRegisterFixedForAnyEmployee"
    >
      定時決定（該当者/一括）
    </button>
    
      
    <button
    mat-raised-button
    color="warn"
    (click)="registerRevisedForAll()"
    [disabled]="!selectedMonth || !canRegisterRevisedForAnyEmployee"
  >
    随時改定（該当者/一括）
  </button>

        <button mat-raised-button color="accent" (click)="calculateAllBonusPremiums()"
        [disabled]="!canCalculateBonusPremiumForSelectedMonth">
  賞与保険料を計算（当月/一括）
</button>        

        
        <button mat-raised-button
        (click)="applyExemptionForSelectedMonth()"
        [disabled]="!isExemptionButtonEnabled()"
        color="primary">
        免除を適用（当月/一括）
        </button>


        <button
        mat-raised-button
        class="btn-csv"
        (click)="exportMonthlyPremiums()"
        [disabled]="!selectedMonth || displayEmployees.length === 0"
      >
        <mat-icon>download</mat-icon>
        この月のCSVを出力（月額報酬）
      </button>

      <button
      mat-raised-button
      class="btn-csv"
      (click)="exportBonusPremiums()"
      [disabled]="!selectedMonth || bonusEmployees.length === 0"
    >
      <mat-icon>download</mat-icon>
      この月のCSVを出力（賞与）
    </button>

      </div>

      <div class="insurance-note" style="margin: 12px 0; font-size: 1rem; color: #666;">
        <p>※ 従業員別の保険料に占める被保険者負担分は、端数が50銭以下の場合は切り捨て、50銭を超える場合は切り上げて1円</p>
        <p>※ 従業員別の保険料に占める企業負担分（目安）は、端数を切り捨て</p>
        <p>※ 企業全体の保険料に占める被保険者負担分は、被保険者負担分として端数処理した保険料を合計</p>
        <p>※ 企業全体の保険料に占める企業負担分は、企業負担分として端数処理する前の保険料を合計し、合計額の端数を切り捨て</p>
        <p>※ 端数処理タイミングの差異により、保険料合計額の会社負担分（実際の負担）が従業員別の保険料に占める会社負担分（目安）の合計を上回ることがあります</p>
      </div>
  
    </mat-card-content>
  </mat-card>
    
  <mat-card *ngIf="selectedCompanyId && selectedMonth && showEmployeeTable">
    <mat-card-title>従業員一覧（月額報酬）</mat-card-title>
    <mat-card-content>
      <table mat-table [dataSource]="displayEmployees" class="mat-elevation-z1" style="width: 100%;">
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>氏名</th>
          <td mat-cell *matCellDef="let emp">{{ emp.lastName }} {{ emp.firstName }}</td>
        </ng-container>

        <ng-container matColumnDef="grade">
          <th mat-header-cell *matHeaderCellDef>標準報酬月額</th>
          <td mat-cell *matCellDef="let emp" class="standard-monthly-amount" [matTooltip]="getMonthlyBreakdownTooltip(emp)">
            <div *ngIf="emp.standardMonthlyAmount">
              {{ emp.standardMonthlyAmount | number }} 円
            </div>
            <div *ngIf="!emp.standardMonthlyAmount">－</div>
          </td>
        </ng-container>
        
        <ng-container matColumnDef="health">
          <th mat-header-cell *matHeaderCellDef>
            健康保険料
            <button mat-icon-button (click)="toggleColumnDetail('healthInsurance')">
              <mat-icon>{{ healthInsuranceDetailOpenAll ? 'expand_less' : 'expand_more' }}</mat-icon>
            </button>
          </th>
          <td mat-cell *matCellDef="let emp">
            <div>
              {{ emp.healthInsuranceAmount !== null
                ? (emp.healthInsuranceAmount | number) + ' 円（等級：' + (emp.healthGrade ?? '-') + '）'
                : '－' }}
            </div>
            <div *ngIf="emp.healthInsuranceDetailOpen">
              <small>本人：{{ emp.healthInsuranceEmployee | number }} 円 / 会社（目安）：{{ emp.healthInsuranceCompany | number }} 円</small>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="pension">
          <th mat-header-cell *matHeaderCellDef>
            厚生年金保険料
            <button mat-icon-button (click)="toggleColumnDetail('pensionInsurance')">
              <mat-icon>{{ pensionInsuranceDetailOpenAll ? 'expand_less' : 'expand_more' }}</mat-icon>
            </button>
          </th>
          <td mat-cell *matCellDef="let emp">
            <div>
              {{ emp.pensionInsuranceAmount !== null
                ? (emp.pensionInsuranceAmount | number) + ' 円（等級：' + (emp.pensionGrade ?? '-') + '）'
                : '－' }}
            </div>
            <div *ngIf="emp.pensionInsuranceDetailOpen">
              <small>本人：{{ emp.pensionInsuranceEmployee | number }} 円 / 会社（目安）：{{ emp.pensionInsuranceCompany | number }} 円</small>
            </div>
          </td>
        </ng-container>        

        <ng-container matColumnDef="care">
          <th mat-header-cell *matHeaderCellDef>
            介護保険料
            <button mat-icon-button (click)="toggleColumnDetail('careInsurance')">
              <mat-icon>{{ careInsuranceDetailOpenAll ? 'expand_less' : 'expand_more' }}</mat-icon>
            </button>
          </th>
          <td mat-cell *matCellDef="let emp">
            <div>
              {{ emp.careInsuranceAmount !== null
                ? (emp.careInsuranceAmount | number) + ' 円（等級：' + (emp.careGrade ?? '-') + '）'
                : '－' }}
            </div>
            <div *ngIf="emp.careInsuranceDetailOpen">
              <small>本人：{{ emp.careInsuranceEmployee | number }} 円 / 会社（目安）：{{ emp.careInsuranceCompany | number }} 円</small>
            </div>
          </td>
        </ng-container>

        <ng-container *ngIf="userRole === 'hr'" matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>操作</th>
          <td mat-cell *matCellDef="let emp">
            <div class="employee-actions">
              <button
              mat-raised-button
              color="primary"
              (click)="registerQualification(emp)"
              [disabled]="!devForceAllButtons && (
                emp.alreadyRegisteredQualification || selectedMonth !== (emp.joinDate | date:'yyyy-MM')
              )"
            >
              資格取得
            </button>
              <button mat-raised-button color="accent" (click)="registerFixed(emp)" [disabled]="!emp.canRegisterFixed">
                定時決定
              </button>
              <button mat-raised-button color="warn" (click)="registerRevised(emp)" [disabled]="!emp.canRegisterRevised">
                随時改定
              </button>
            </div>
          </td>

        </ng-container>
        
        <tr mat-header-row *matHeaderRowDef="userRole === 'hr'
        ? ['name', 'grade', 'health', 'pension', 'care', 'actions']
        : ['name', 'grade', 'health', 'pension', 'care']"></tr>
        <tr mat-row *matRowDef="let row; columns: userRole === 'hr'
        ? ['name', 'grade', 'health', 'pension', 'care', 'actions']
        : ['name', 'grade', 'health', 'pension', 'care']"></tr>

      </table>

      <mat-card *ngIf="userRole === 'hr' && displayEmployees.length > 0" class="total-premium-summary" style="margin-top: 16px;">
        <mat-card-content>
          <div style="display: flex; flex-direction: column; gap: 4px; max-width: 560px;">
            <div style="display: flex;">
              <div style="width: 180px; font-weight: bold;">健康保険料 合計：</div>
              <div>
                {{ getTotalPremiums().health | number }} 円
                （従業員：{{ getTotalPremiums().healthEmployee | number }} 円 + 会社：{{ getTotalPremiums().healthCompany | number }} 円）
              </div>
            </div>
        
            <div style="display: flex;">
              <div style="width: 180px; font-weight: bold;">厚生年金保険料 合計：</div>
              <div>
                {{ getTotalPremiums().pension | number }} 円
                （従業員：{{ getTotalPremiums().pensionEmployee | number }} 円 + 会社：{{ getTotalPremiums().pensionCompany | number }} 円）
              </div>
            </div>
        
            <div style="display: flex;">
              <div style="width: 180px; font-weight: bold;">介護保険料 合計：</div>
              <div>
                {{ getTotalPremiums().care | number }} 円
                （従業員：{{ getTotalPremiums().careEmployee | number }} 円 + 会社：{{ getTotalPremiums().careCompany | number }} 円）
              </div>
            </div>
        
            <div style="display: flex;">
              <div style="width: 180px; font-weight: bold;">総合計：</div>
              <div>
                {{ getTotalPremiums().total | number }} 円
              </div>
            </div>
          </div>
        </mat-card-content>        
        
      </mat-card>
      

      <mat-card *ngIf="selectedCompanyId && selectedMonth && showBonusTable">
        <mat-card-title>従業員一覧（賞与）</mat-card-title>
        <mat-card-content>
          <table mat-table [dataSource]="bonusEmployees" class="mat-elevation-z1" style="width: 100%;">
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>氏名</th>
              <td mat-cell *matCellDef="let emp">{{ emp.lastName }} {{ emp.firstName }}</td>
            </ng-container>
      
            <ng-container matColumnDef="bonusAmount">
              <th mat-header-cell *matHeaderCellDef>標準賞与額</th>
              <td mat-cell *matCellDef="let emp">{{ emp.bonusStandardAmount | number }} 円</td>
            </ng-container>

            <ng-container matColumnDef="bonusMergedIntoMonthly">
              <th mat-header-cell *matHeaderCellDef>標準報酬に含む</th>
              <td mat-cell *matCellDef="let emp">
                {{ emp.bonusMergedIntoMonthly ? '〇' : '×' }}
              </td>
            </ng-container>
      
            <ng-container matColumnDef="bonusHealth">
              <th mat-header-cell *matHeaderCellDef>
                健康保険料
                <button mat-icon-button (click)="toggleBonusDetail('health')">
                  <mat-icon>{{ bonusHealthDetailOpenAll ? 'expand_less' : 'expand_more' }}</mat-icon>
                </button>
              </th>
              <td mat-cell *matCellDef="let emp">
                <div>
                  {{ emp.bonusHealth !== null ? (emp.bonusHealth | number) + ' 円' : '－' }}
                </div>
                <div *ngIf="emp.bonusHealthDetailOpen">
                  <small>本人：{{ emp.bonusHealthEmployee | number }} 円 / 会社（目安）：{{ emp.bonusHealthCompany | number }} 円</small>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="bonusPension">
              <th mat-header-cell *matHeaderCellDef>
                厚生年金保険料
                <button mat-icon-button (click)="toggleBonusDetail('pension')">
                  <mat-icon>{{ bonusPensionDetailOpenAll ? 'expand_less' : 'expand_more' }}</mat-icon>
                </button>
              </th>
              <td mat-cell *matCellDef="let emp">
                <div>
                  {{ emp.bonusPension !== null ? (emp.bonusPension | number) + ' 円' : '－' }}
                </div>
                <div *ngIf="emp.bonusPensionDetailOpen">
                  <small>本人：{{ emp.bonusPensionEmployee | number }} 円 / 会社（目安）：{{ emp.bonusPensionCompany | number }} 円</small>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="bonusCare">
              <th mat-header-cell *matHeaderCellDef>
                介護保険料
                <button mat-icon-button (click)="toggleBonusDetail('care')">
                  <mat-icon>{{ bonusCareDetailOpenAll ? 'expand_less' : 'expand_more' }}</mat-icon>
                </button>
              </th>
              <td mat-cell *matCellDef="let emp">
                <div>
                  {{ emp.bonusCare !== null ? (emp.bonusCare | number) + ' 円' : '－' }}
                </div>
                <div *ngIf="emp.bonusCareDetailOpen">
                  <small>本人：{{ emp.bonusCareEmployee | number }} 円 / 会社（目安）：{{ emp.bonusCareCompany | number }} 円</small>
                </div>
              </td>
            </ng-container>


      
            <tr mat-header-row *matHeaderRowDef="
            userRole === 'hr'
              ? ['name', 'bonusAmount', 'bonusMergedIntoMonthly', 'bonusHealth', 'bonusPension', 'bonusCare']
              : ['name', 'bonusAmount', 'bonusMergedIntoMonthly', 'bonusHealth', 'bonusPension', 'bonusCare']
          "></tr>
          
          <tr mat-row *matRowDef="let row; columns: 
            userRole === 'hr'
              ? ['name', 'bonusAmount', 'bonusMergedIntoMonthly', 'bonusHealth', 'bonusPension', 'bonusCare']
              : ['name', 'bonusAmount', 'bonusMergedIntoMonthly', 'bonusHealth', 'bonusPension', 'bonusCare']
          "></tr>          

          </table>

          <mat-card *ngIf="userRole === 'hr' && displayEmployees.length > 0" class="total-premium-summary" style="margin-top: 16px;">
            <mat-card-content>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <div>
                  <strong>健康保険料 合計:</strong>
                  {{ getTotalBonusPremiums().health | number }} 円
                  （従業員：{{ getTotalBonusPremiums().healthEmployee | number }} 円 + 会社：{{ getTotalBonusPremiums().healthCompany | number }} 円）
                </div>
                <div>
                  <strong>厚生年金保険料 合計:</strong>
                  {{ getTotalBonusPremiums().pension | number }} 円
                  （従業員：{{ getTotalBonusPremiums().pensionEmployee | number }} 円 + 会社：{{ getTotalBonusPremiums().pensionCompany | number }} 円）
                </div>
                <div>
                  <strong>介護保険料 合計:</strong>
                  {{ getTotalBonusPremiums().care | number }} 円
                  （従業員：{{ getTotalBonusPremiums().careEmployee | number }} 円 + 会社：{{ getTotalBonusPremiums().careCompany | number }} 円）
                </div>
                <div>
                  <strong>総合計:</strong> {{ getTotalBonusPremiums().total | number }} 円
                </div>
              </div>
            </mat-card-content>
          </mat-card>
          
          
        </mat-card-content>
      </mat-card>
      
    </mat-card-content>
  </mat-card>
</div>

<h2 mat-dialog-title>{{ isEdit ? '従業員情報を編集' : '新規従業員を追加' }}</h2>

<mat-dialog-content class="employee-dialog-content">

  <mat-tab-group>

    <mat-tab label="基本情報">
      <form class="employee-form" aria-label="従業員情報フォーム" #form="ngForm">

        <mat-form-field class="form-field">
          <mat-label>社員番号</mat-label>
          <input
            matInput
            [(ngModel)]="employee.empNo"
            name="empNo"
            required
            #empNoCtrl="ngModel"
          >
          <mat-error *ngIf="empNoCtrl.invalid && empNoCtrl.touched">
            社員番号は必須です
          </mat-error>
        </mat-form-field>

        <div class="form-row">
          <mat-form-field class="form-field">
            <mat-label>姓</mat-label>
            <input matInput [(ngModel)]="employee.lastName" name="lastName" required #lastNameCtrl="ngModel">
            <mat-error *ngIf="lastNameCtrl.invalid && lastNameCtrl.touched">姓は必須です</mat-error>
          </mat-form-field>

          <mat-form-field class="form-field">
            <mat-label>名</mat-label>
            <input matInput [(ngModel)]="employee.firstName" name="firstName" required #firstNameCtrl="ngModel">
            <mat-error *ngIf="firstNameCtrl.invalid && firstNameCtrl.touched">名は必須です</mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field class="form-field">
            <mat-label>セイ</mat-label>
            <input matInput [(ngModel)]="employee.lastNameKana" name="lastNameKana" required #lastNameKanaCtrl="ngModel">
            <mat-error *ngIf="lastNameKanaCtrl.invalid && lastNameKanaCtrl.touched">姓（カナ）は必須です</mat-error>
          </mat-form-field>

          <mat-form-field class="form-field">
            <mat-label>メイ</mat-label>
            <input matInput [(ngModel)]="employee.firstNameKana" name="firstNameKana" required #firstNameKanaCtrl="ngModel">
            <mat-error *ngIf="firstNameKanaCtrl.invalid && firstNameKanaCtrl.touched">名（カナ）は必須です</mat-error>
          </mat-form-field>
        </div>

        <div *ngIf="!isEdit" class="form-row">
          <mat-form-field class="form-field">
            <mat-label>メールアドレス</mat-label>
            <input matInput [(ngModel)]="employee.email" name="email" required #emailCtrl="ngModel" type="email">
            <mat-error *ngIf="emailCtrl.invalid && emailCtrl.touched">有効なメールアドレスを入力してください</mat-error>
          </mat-form-field>
        
          <mat-form-field class="form-field">
            <mat-label>仮パスワード</mat-label>
            <input matInput [(ngModel)]="employee.password" name="password" required #passwordCtrl="ngModel" type="password" minlength="6">
            <mat-error *ngIf="passwordCtrl.invalid && passwordCtrl.touched">6文字以上のパスワードを入力してください</mat-error>
          </mat-form-field>
        </div>

        <mat-form-field class="form-field">
          <mat-label>所属</mat-label>
          <input matInput [(ngModel)]="employee.dept" name="dept">
        </mat-form-field>

        <mat-form-field class="form-field">
          <mat-label>雇用区分</mat-label>
          <mat-select [(ngModel)]="employee.employmentType" name="employmentType" required #employmentTypeCtrl="ngModel">
            <mat-option *ngFor="let type of employmentTypes" [value]="type">{{ type }}</mat-option>
          </mat-select>
          <mat-error *ngIf="employmentTypeCtrl.invalid && employmentTypeCtrl.touched">雇用区分は必須です</mat-error>
        </mat-form-field>

        <mat-form-field class="form-field">
          <mat-label>週所定労働時間（h）</mat-label>
          <input matInput type="number" [(ngModel)]="employee.weeklyHours" name="weeklyHours" required #weeklyHoursCtrl="ngModel">
          <mat-error *ngIf="weeklyHoursCtrl.invalid && weeklyHoursCtrl.touched">週所定労働時間は必須です</mat-error>
        </mat-form-field>

        <mat-form-field class="form-field">
          <mat-label>雇用期間の見込み</mat-label>
          <mat-select [(ngModel)]="employee.expectedDuration" name="expectedDuration" required #expectedDurationCtrl="ngModel">
            <mat-option value="within2Months">2か月以内</mat-option>
            <mat-option value="over2Months">2か月超</mat-option>
            <mat-option value="indefinite">期間の定めなし</mat-option>
          </mat-select>
          <mat-error *ngIf="expectedDurationCtrl.invalid && expectedDurationCtrl.touched">雇用期間の見込みは必須です</mat-error>
        </mat-form-field>

        <mat-form-field class="form-field">
          <mat-label>入社日</mat-label>
          <input
            matInput
            [matDatepicker]="joinPicker"
            [(ngModel)]="employee.joinDate"
            name="joinDate"
            required
            #joinDateCtrl="ngModel"
          >
          <mat-datepicker-toggle matSuffix [for]="joinPicker"></mat-datepicker-toggle>
          <mat-datepicker #joinPicker></mat-datepicker>
          <mat-error *ngIf="joinDateCtrl.invalid && joinDateCtrl.touched">
            入社日は必須です
          </mat-error>
        </mat-form-field>        

        <mat-form-field class="form-field">
          <mat-label>退職予定日(未定の場合は空欄可)</mat-label>
          <input matInput [matDatepicker]="leavePicker" [(ngModel)]="employee.leaveDate" name="leaveDate">
          <mat-datepicker-toggle matSuffix [for]="leavePicker"></mat-datepicker-toggle>
          <mat-datepicker #leavePicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field class="form-field">
          <mat-label>生年月日</mat-label>
          <input matInput [matDatepicker]="dobPicker" [(ngModel)]="employee.birthday" name="birthday" required #birthdayCtrl="ngModel">
          <mat-datepicker-toggle matSuffix [for]="dobPicker"></mat-datepicker-toggle>
          <mat-datepicker #dobPicker></mat-datepicker>
          <mat-error *ngIf="birthdayCtrl.invalid && birthdayCtrl.touched">生年月日は必須です</mat-error>
        </mat-form-field>

        <mat-form-field class="form-field">
          <mat-label>学生区分</mat-label>
          <mat-select [(ngModel)]="employee.studentStatus" name="studentStatus" required #studentStatusCtrl="ngModel">
            <mat-option value="none">該当なし</mat-option>
            <mat-option value="daytime">昼間部学生</mat-option>
            <mat-option value="nighttime">夜間学生</mat-option>
            <mat-option value="correspondence">通信課程</mat-option>
          </mat-select>
          <mat-error *ngIf="studentStatusCtrl.invalid && studentStatusCtrl.touched">学生区分は必須です</mat-error>
        </mat-form-field>

        <mat-checkbox [(ngModel)]="employee.excludedBySocialAgreement" name="excludedBySocialAgreement">
          日本との社会保障協定により適用除外（健康保険・介護保険・厚生年金）
        </mat-checkbox>

        <mat-checkbox [(ngModel)]="employee.isDependentInsured" name="isDependentInsured">
          本人が家族の扶養に入っている（健保・介保は原則対象外）
        </mat-checkbox>

        <mat-form-field class="form-field">
          <mat-label>備考</mat-label>
          <textarea matInput rows="2" [(ngModel)]="employee.note" name="note"></textarea>
        </mat-form-field>
      </form>
    </mat-tab>

    <mat-tab label="報酬・手当">
      <app-income-record-list
      [companyId]="companyId"
      [empNo]="employee.empNo"
      [incomeRecords]="incomeRecords"
      [bonusMergedIntoMonthly]="employee.bonusMergedIntoMonthly"
      (incomeRecordsChange)="incomeRecords = $event">
    </app-income-record-list>
    </mat-tab>
    
    <mat-tab label="賞与">
      <app-bonus-summary
      [companyId]="companyId"
      [empNo]="employee.empNo"
      (bonusChange)="onBonusChange($event)"></app-bonus-summary>
    </mat-tab>

    <mat-tab label="扶養者情報">
      <app-dependent-edit-dialog
      [companyId]="companyId"
      [empNo]="employee.empNo"
      [dependents]="dependents"
      (dependentsChange)="dependents = $event">
    </app-dependent-edit-dialog>
    </mat-tab>

    <mat-tab label="減免情報">
      <div class="form-section">
    
        <mat-checkbox [(ngModel)]="employee.hasExemption" name="hasExemption">
          制度上の理由により減免対象となっている
        </mat-checkbox>
    
        <div *ngIf="employee.hasExemption" class="form-group">
    
          <mat-form-field class="form-field" appearance="fill">
            <mat-label>減免理由（複数選択可）</mat-label>
            <mat-select multiple [(ngModel)]="employee.exemptionDetails.types" name="exemptionTypes">
              <mat-option value="育児休業">育児休業</mat-option>
              <mat-option value="産前産後">産前産後</mat-option>
              <mat-option value="障害者">障害者</mat-option>
              <mat-option value="災害">災害</mat-option>
              <mat-option value="任意継続軽減">任意継続軽減</mat-option>
              <mat-option value="その他">その他</mat-option>
            </mat-select>
          </mat-form-field>
    
          <mat-form-field class="form-field" appearance="fill">
            <mat-label>対象となる保険（複数選択可）</mat-label>
            <mat-select multiple [(ngModel)]="employee.exemptionDetails.targetInsurances" name="targetInsurances">
              <mat-option value="health">健康保険</mat-option>
              <mat-option value="care">介護保険</mat-option>
              <mat-option value="pension">厚生年金</mat-option>
            </mat-select>
          </mat-form-field>
    
          <div class="form-row">
            <mat-form-field class="form-field">
              <mat-label>減免開始月</mat-label>
              <input matInput [(ngModel)]="employee.exemptionDetails.startMonth" name="exemptionStartMonth" placeholder="2025-01">
            </mat-form-field>
    
            <mat-form-field class="form-field">
              <mat-label>減免終了月</mat-label>
              <input matInput [(ngModel)]="employee.exemptionDetails.endMonth" name="exemptionEndMonth" placeholder="2025-06">
            </mat-form-field>
          </div>
    
          <mat-form-field class="form-field">
            <mat-label>備考</mat-label>
            <textarea matInput rows="2" [(ngModel)]="employee.exemptionDetails.notes" name="exemptionNotes"></textarea>
          </mat-form-field>
    
        </div>
      </div>
    </mat-tab>    

  </mat-tab-group>
</mat-dialog-content>

<mat-dialog-actions align="end" aria-label="操作ボタン">
  <button mat-stroked-button mat-dialog-close>キャンセル</button>
  <button mat-flat-button color="primary" (click)="save(form)">保存</button>
</mat-dialog-actions>

